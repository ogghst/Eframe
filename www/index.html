<!DOCTYPE html>
<html>
<head>
    <title>E-Ink Dashboard Configuration</title>
</head>
<body>
    <h1>E-Ink Dashboard Configuration</h1>

    <h2>Upload Configuration</h2>
    <form id="upload-form" onsubmit="event.preventDefault(); uploadConfig();">
        <input type="file" id="config-file" name="config" accept=".json" required>
        <input type="submit" value="Upload">
    </form>

    <h2>Status</h2>
    <div id="status">
        <p>Wi-Fi Status: <span id="wifi-status">Unknown</span></p>
        <p>MQTT Status: <span id="mqtt-status">Unknown</span></p>
    </div>

    <h2>System</h2>
    <button onclick="reboot()">Reboot Device</button>

    <script>
        function getStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('wifi-status').textContent = data.wifi;
                    document.getElementById('mqtt-status').textContent = data.mqtt;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    document.getElementById('wifi-status').textContent = 'Error';
                    document.getElementById('mqtt-status').textContent = 'Error';
                });
        }

        function reboot() {
            if (confirm('Are you sure you want to reboot the device?')) {
                fetch('/reboot', { method: 'POST' })
                    .then(() => alert('Device is rebooting.'))
                    .catch(error => console.error('Error rebooting:', error));
            }
        }

        function uploadConfig() {
            const fileInput = document.getElementById('config-file');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file first.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const fileContent = e.target.result;
                fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: fileContent,
                })
                .then(response => {
                    if (response.ok) {
                        alert("Configuration uploaded successfully! The device will now reboot to apply the changes.");
                        reboot();
                    } else {
                        alert("Upload failed. Please check the file and try again.");
                    }
                })
                .catch(error => {
                    console.error('Error uploading configuration:', error);
                    alert("An error occurred during upload.");
                });
            };
            reader.readAsText(file);
        }

        // Fetch status every 5 seconds
        setInterval(getStatus, 5000);
        // Initial status fetch
        getStatus();
    </script>
</body>
</html>
